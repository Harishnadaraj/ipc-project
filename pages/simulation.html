<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>IPC Simulation — Bubble Animation</title>

<style>
:root {
  --bg: #f5f7fa;
  --card: #ffffff;
  --accent: #0071e3;
  --accent2: #9855ff;
  --muted: #64748b;
  --text: #0f172a;
  --radius: 18px;
  --shadow: 0 18px 40px rgba(0,0,0,0.08);
}

* { box-sizing: border-box; }
body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", Inter, Arial;
  background: var(--bg);
  color: var(--text);
  -webkit-font-smoothing: antialiased;
}

/* NAVBAR */
.navbar {
  position: sticky;
  top: 0;
  padding: 14px 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: rgba(255,255,255,0.75);
  backdrop-filter: blur(12px);
  box-shadow: 0 2px 12px rgba(0,0,0,0.05);
  z-index: 50;
}
.brand {
  font-weight: 800;
  font-size: 18px;
  color: var(--accent);
}
.navbar a {
  margin-left: 16px;
  text-decoration: none;
  font-weight: 600;
  color: var(--text);
}
.navbar a:hover { color: var(--accent); }

/* LAYOUT */
.container {
  max-width: 1100px;
  margin: 30px auto;
  padding: 0 20px;
}

/* HERO */
.hero-title {
  font-size: 34px;
  font-weight: 800;
}
.hero-sub {
  color: var(--muted);
  margin-bottom: 20px;
}

/* CONTROLS */
.controls {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin: 20px 0;
}
.tab {
  padding: 10px 16px;
  border-radius: 10px;
  background: #eef6ff;
  border: none;
  cursor: pointer;
  font-weight: 700;
}
.tab.active {
  background: linear-gradient(90deg, #dff4ff, #f3e8ff);
}
.btn {
  padding: 10px 14px;
  border-radius: 10px;
  border: none;
  cursor: pointer;
  font-weight: 700;
  color: #fff;
  background: linear-gradient(90deg, var(--accent), var(--accent2));
}
.btn.pause-btn {
  background: #e2e8f0;
  color: #1e293b;
}
select {
  padding: 10px;
  border-radius: 8px;
}

/* STAGE */
.stage {
  position: relative;
  height: 380px;
  background: var(--card);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  overflow: hidden;
  padding: 20px;
}

/* Nodes */
.node {
  position: absolute;
  width: 180px;
  height: 110px;
  background: rgba(255,255,255,0.92);
  backdrop-filter: blur(8px);
  box-shadow: 0 14px 30px rgba(0,0,0,0.07);
  border-radius: 16px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  text-align: center;
}

/* Positions */
#producer { top: 140px; left: 20px; }
#ipc      { top: 100px; left: calc(50% - 90px); }
#consumer { top: 140px; right: 20px; }

.pipe {
  position: absolute;
  top: 180px;
  left: 180px;
  right: 180px;
  height: 10px;
  border-radius: 999px;
  background: linear-gradient(90deg, #def, #fde);
}

/* Bubble particle */
.bubble {
  position: absolute;
  width: 26px;
  height: 26px;
  border-radius: 999px;
  background: linear-gradient(90deg, #007aff, #00c6ff);
  box-shadow: 0 12px 24px rgba(0,0,0,0.15);
}

/* Narration + Metrics */
.side-card {
  margin-top: 20px;
  background: var(--card);
  padding: 18px;
  border-radius: 16px;
  box-shadow: var(--shadow);
}
.side-title { margin: 0 0 6px; font-weight: 700; }
.metric-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  margin-top: 12px;
}
.metric-grid div { margin-bottom: 8px; }

</style>
</head>

<body>

<header class="navbar">
  <div class="brand">IPC Simulation</div>
  <div>
    <a href="../index.html" target="_blank">Home</a>
    <a href="overview.html" target="_blank">Overview</a>
  </div>
</header>

<div class="container">

  <h1 class="hero-title">IPC Simulation — Bubble Flow</h1>
  <p class="hero-sub">Experience FIFO, Message Queues, and Shared Memory with smooth animations.</p>

  <!-- CONTROLS -->
  <div class="controls">
    <button class="tab active" data-mode="FIFO">FIFO</button>
    <button class="tab" data-mode="MQ">Message Queue</button>
    <button class="tab" data-mode="SHM">Shared Memory</button>

    <button class="btn" id="play">▶ Play</button>
    <button class="btn pause-btn" id="pause">⏸ Pause</button>
    <button class="btn" id="step">⭢ Step</button>
    <button class="btn" id="reset">⟲ Restart</button>

    <select id="speed">
      <option value="1">Normal</option>
      <option value="1.5">Fast</option>
      <option value="0.6">Slow</option>
    </select>
  </div>

  <!-- SIMULATION STAGE -->
  <div class="stage" id="stage">
    <div class="pipe"></div>

    <div class="node" id="producer">
      <strong>Producer</strong>
      <span style="color:var(--muted)">writes</span>
    </div>

    <div class="node" id="ipc">
      <strong>IPC Layer</strong>
      <span style="color:var(--muted)">transport</span>
    </div>

    <div class="node" id="consumer">
      <strong>Consumer</strong>
      <span style="color:var(--muted)">reads</span>
    </div>
  </div>

  <!-- Narration -->
  <div class="side-card">
    <h3 class="side-title">Live Narration</h3>
    <p id="narration" style="color:var(--muted)">Choose a mode and press Play.</p>

    <div class="metric-grid">
      <div><b>Sent:</b> <span id="sent">0</span></div>
      <div><b>Received:</b> <span id="received">0</span></div>
      <div><b>Queue:</b> <span id="queue">0</span></div>
      <div><b>Semaphore:</b> <span id="sem">false</span></div>
    </div>
  </div>

</div>

<script>
/* SIMULATION ENGINE — clean, stable, fast */
const stage = document.getElementById("stage");
const narration = msg => document.getElementById("narration").innerText = msg;

const sentEl = document.getElementById("sent");
const recvEl = document.getElementById("received");
const queueEl = document.getElementById("queue");
const semEl = document.getElementById("sem");

let mode = "FIFO";
let running = false;
let loopRef = null;

let sent = 0, recv = 0, queue = 0, sem = false;

document.querySelectorAll(".tab").forEach(tab => {
  tab.onclick = () => {
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    tab.classList.add("active");
    mode = tab.dataset.mode;
    reset();
  };
});

function bubble(color="#00aaff") {
  let b = document.createElement("div");
  b.className = "bubble";
  b.style.background = color;
  stage.appendChild(b);
  return b;
}

function moveBubble(b, x1,y1, x2,y2, speed=1) {
  return new Promise(resolve => {
    const duration = 900 / speed;
    const start = performance.now();

    function animate(now) {
      let t = Math.min((now - start) / duration, 1);
      b.style.left = x1 + (x2 - x1)*t + "px";
      b.style.top = y1 + (y2 - y1)*t + "px";
      if(t < 1 && running) requestAnimationFrame(animate);
      else { b.remove(); resolve(); }
    }
    requestAnimationFrame(animate);
  });
}

/* MAIN ACTION STEPS */
async function step() {
  if(mode === "FIFO") await fifoStep();
  if(mode === "MQ")   await mqStep();
  if(mode === "SHM")  await shmStep();
}

/* FIFO */
async function fifoStep() {
  narration("FIFO → Producer writes sequential stream.");

  sent++; sentEl.innerText = sent;

  let b = bubble();

  await moveBubble(b, 60,170, 520,150);
  narration("Stream forwarded to consumer.");
  let b2 = bubble();

  await moveBubble(b2, 520,150, 950,170);

  recv++; recvEl.innerText = recv;
}

/* MQ */
async function mqStep() {
  let high = Math.random() < 0.3;
  let color = high ? "linear-gradient(90deg,#00d68f,#00ffb1)" : "linear-gradient(90deg,#007aff,#00c6ff)";
  let b = bubble(color);

  sent++; queue++; 
  sentEl.innerText = sent; queueEl.innerText = queue;

  narration("MQ → Message queued" + (high ? " (HIGH PRIORITY)" : ""));

  await moveBubble(b, 60,170, 520,150);

  queue--; queueEl.innerText = queue;
  narration("MQ → Message dequeued → delivered");

  let b2 = bubble(color);
  await moveBubble(b2, 520,150, 950,170);

  recv++; recvEl.innerText = recv;
}

/* SHM */
async function shmStep() {
  narration("SHM → Producer writes into shared memory block.");
  sem = true; semEl.innerText = sem;

  sent++; sentEl.innerText = sent;

  await new Promise(r => setTimeout(r, 400));

  let b = bubble("linear-gradient(90deg,#ffb84d,#ff8a00)");
  narration("SHM → Semaphore posted.");
  await moveBubble(b, 60,170, 510,170);

  let b2 = bubble();
  narration("SHM → Consumer reads zero-copy data.");
  await moveBubble(b2, 520,160, 950,170);

  recv++; recvEl.innerText = recv;
  sem = false; semEl.innerText = sem;
}

/* LOOP */
async function loop() {
  running = true;
  narration("Running...");
  loopRef = setInterval(() => step(), 1200);
}

/* CONTROLS */
document.getElementById("play").onclick = () => { 
  if(!running) loop(); 
};

document.getElementById("pause").onclick = () => { 
  running = false; 
  narration("Paused.");
  clearInterval(loopRef);
};

document.getElementById("step").onclick = () => { 
  running = false;
  clearInterval(loopRef);
  step(); 
};

document.getElementById("reset").onclick = reset;

function reset() {
  running = false;
  clearInterval(loopRef);
  narration("Reset — choose mode and press Play.");
  sent = recv = queue = 0;
  sem = false;
  sentEl.innerText = recvEl.innerText = queueEl.innerText = 0;
  semEl.innerText = "false";
}

</script>

</body>
</html>
